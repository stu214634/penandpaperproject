import{j as e,B as o,P as R,I as B,a0 as oe,d as l,a2 as G,e as j,al as le,L as K,f as Q,g as de,aa as ce,am as ue,h as X,o as w,an as xe,a1 as he,ad as pe,ao as me,N as D,X as L,Y as N,l as ge,m as je,n as fe,ae as ye,af as ve,ag as Ie,ah as Y,r as Ce}from"./mui-vendor-BNyFSCPN.js";import{r as d,i as be,u as ke}from"./react-vendor-BzdEknB4.js";import{u as M,M as Pe}from"./index-B572UWve.js";import"./map-vendor-CMk8R3PE.js";import"./utilities-BTDtKTyc.js";const we=({combat:a,onClose:$})=>{const S=M(n=>n.playTrack),f=M(n=>n.stopIndividualTrack),y=M(n=>n.characters),g=d.useRef(null),p=d.useRef(null),I=d.useRef(!1),[c,C]=d.useState([]),[u,b]=d.useState(0),[J,E]=d.useState(1),[Z,H]=d.useState(!1),[T,W]=d.useState(""),[F,U]=d.useState(10),[O,_]=d.useState(null),[z,A]=d.useState(null);d.useEffect(()=>{if(!I.current){if(a.entrySound){const n=`/audio/${a.entrySound}`;g.current=n,S(n,{replace:!1,locationId:`combat-entrysound-${a.id}`,loop:!1})}if(a.backgroundMusic){const n=`/audio/${a.backgroundMusic}`;p.current=n,S(n,{replace:!1,locationId:`combat-bgm-${a.id}`,loop:!0})}I.current=!0}return()=>{g.current&&(f(g.current),g.current=null),p.current&&(f(p.current),p.current=null)}},[a.id,a.entrySound,a.backgroundMusic]),d.useEffect(()=>{ee()},[]);const ee=()=>{const n=a.playerCharacters.map(r=>({id:`pc-${r.id}-${Math.random().toString(36).substring(2,9)}`,character:r,initiative:0,currentHp:r.hp,maxHp:r.hp,notes:"",isPlayerCharacter:!0})),s=a.enemies.map(r=>({id:`enemy-${r.id}-${Math.random().toString(36).substring(2,9)}`,character:r,initiative:Math.floor(Math.random()*20)+1,currentHp:r.hp,maxHp:r.hp,notes:"",isPlayerCharacter:!1})),t=[...n,...s].sort((r,h)=>h.initiative-r.initiative);C(t),b(0),E(1)},ne=()=>{if(c.length===0)return;const n=(u+1)%c.length;b(n),A(c[n].id),n===0&&E(s=>s+1)},x=c[u],i=c.find(n=>n.id===(z||(x==null?void 0:x.id)));d.useEffect(()=>{x&&!z&&A(x.id)},[x]);const te=()=>{var m;if(!T)return;const n=y.find(v=>v.id===T);if(!n)return;const s=n.type==="player",t={id:`${s?"pc":"enemy"}-${n.id}-${Math.random().toString(36).substring(2,9)}`,character:n,initiative:F,currentHp:n.hp,maxHp:n.hp,notes:"",isPlayerCharacter:s},r=[...c,t].sort((v,se)=>se.initiative-v.initiative),h=(m=c[u])==null?void 0:m.id,P=h?r.findIndex(v=>v.id===h):0;C(r),b(P>=0?P:0),H(!1),W(""),U(10)},ie=(n,s)=>{var P;const t=c.map(m=>m.id===n?{...m,initiative:s}:m).sort((m,v)=>v.initiative-m.initiative),r=(P=c[u])==null?void 0:P.id,h=r?t.findIndex(m=>m.id===r):0;C(t),b(h>=0?h:0)},k=(n,s)=>{C(c.map(t=>t.id===n?{...t,currentHp:Math.max(0,Math.min(s,t.maxHp))}:t))},V=(n,s)=>{C(c.map(t=>t.id===n?{...t,notes:s}:t))},re=n=>{const s=c.findIndex(h=>h.id===n);if(s===-1)return;const t=c.filter(h=>h.id!==n);if(t.length===0){q();return}let r=u;s===u?r=u%t.length:s<u&&(r=u-1),C(t),b(r)},ae=n=>{A(n)},q=()=>{g.current&&(f(g.current),g.current=null),p.current&&(f(p.current),p.current=null),$()};return e.jsxs(o,{sx:{height:"100%",width:"100%",display:"flex",flexDirection:"column",overflow:"hidden",position:"relative",backgroundColor:"#222",backgroundImage:a.backgroundImage?`url(/images/${a.backgroundImage})`:"none",backgroundSize:"cover",backgroundPosition:"center"},children:[e.jsx(o,{sx:{position:"absolute",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.5)",zIndex:0}}),e.jsxs(R,{sx:{p:2,mb:2,display:"flex",justifyContent:"space-between",alignItems:"center",backgroundColor:"rgba(30, 30, 30, 0.9)",position:"relative",zIndex:1},children:[e.jsxs(o,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(B,{onClick:q,sx:{mr:1},children:e.jsx(oe,{})}),e.jsx(l,{variant:"h5",children:a.name})]}),e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(G,{label:`Round: ${J}`,color:"primary",variant:"outlined"}),e.jsx(G,{label:`Difficulty: ${a.difficulty||"Medium"}`,color:"secondary",variant:"outlined"}),e.jsx(j,{variant:"contained",color:"primary",startIcon:e.jsx(le,{}),onClick:()=>H(!0),children:"Add Participant"})]})]}),e.jsxs(o,{sx:{display:"flex",flex:1,overflow:"hidden",position:"relative",zIndex:1,gap:2,p:2},children:[e.jsxs(R,{sx:{width:300,overflow:"auto",backgroundColor:"rgba(30, 30, 30, 0.8)",p:1},children:[e.jsx(l,{variant:"h6",sx:{mb:2,p:1},children:"Initiative Order"}),e.jsx(K,{children:c.map((n,s)=>e.jsxs(Q,{sx:{mb:1,backgroundColor:s===u?"rgba(255, 165, 0, 0.3)":n.id===z&&s!==u?"rgba(25, 118, 210, 0.2)":"transparent",borderLeft:s===u?"4px solid orange":n.id===z?"4px solid #1976d2":"4px solid transparent",transition:"all 0.3s ease",borderRadius:"4px",cursor:"pointer"},onClick:()=>ae(n.id),secondaryAction:e.jsx(B,{edge:"end",size:"small",onClick:t=>{t.stopPropagation(),re(n.id)},children:e.jsx(pe,{fontSize:"small"})}),children:[e.jsx(de,{children:n.isPlayerCharacter?e.jsx(ce,{color:"primary"}):e.jsx(ue,{color:"error"})}),e.jsx(X,{primary:e.jsxs(o,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsx(l,{variant:"body1",children:n.character.name}),e.jsxs(o,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(xe,{badgeContent:n.initiative,color:"primary",sx:{mr:1}}),e.jsx(B,{size:"small",onClick:t=>{t.stopPropagation(),_(n.id===O?null:n.id)},children:e.jsx(he,{fontSize:"small"})})]})]}),secondary:e.jsxs(o,{children:[e.jsxs(l,{variant:"caption",component:"div",children:["HP: ",n.currentHp,"/",n.maxHp]}),O===n.id&&e.jsxs(o,{sx:{mt:1,display:"flex",flexDirection:"column",gap:1},children:[e.jsx(w,{label:"Initiative",type:"number",size:"small",value:n.initiative,onChange:t=>ie(n.id,parseInt(t.target.value)||0)}),e.jsx(w,{label:"Current HP",type:"number",size:"small",value:n.currentHp,onChange:t=>k(n.id,parseInt(t.target.value)||0)}),e.jsx(w,{label:"Notes",size:"small",multiline:!0,rows:2,value:n.notes,onChange:t=>V(n.id,t.target.value)})]})]})})]},n.id))})]}),e.jsx(R,{sx:{flex:1,p:2,backgroundColor:"rgba(30, 30, 30, 0.8)",display:"flex",flexDirection:"column"},children:i?e.jsxs(e.Fragment,{children:[e.jsxs(o,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsxs(o,{children:[e.jsx(l,{variant:"h5",children:i.id===(x==null?void 0:x.id)?`Current Turn: ${i.character.name}`:i.character.name}),i.id!==(x==null?void 0:x.id)&&e.jsx(l,{variant:"caption",color:"text.secondary",children:"Viewing details - not the active turn"})]}),e.jsx(j,{variant:"contained",color:"secondary",endIcon:e.jsx(me,{}),onClick:ne,children:"Next Turn"})]}),e.jsxs(D,{container:!0,spacing:2,children:[e.jsx(D,{item:!0,xs:12,md:6,children:e.jsx(L,{sx:{backgroundColor:"rgba(40, 40, 40, 0.9)",height:"100%"},children:e.jsxs(N,{children:[e.jsx(l,{variant:"h6",gutterBottom:!0,children:"Character Details"}),e.jsxs(l,{variant:"body1",children:["Type: ",i.character.type.toUpperCase()]}),e.jsxs(l,{variant:"body1",children:["HP: ",i.currentHp,"/",i.maxHp]}),e.jsxs(o,{sx:{mt:2},children:[i.character.descriptionType==="markdown"&&e.jsx(Pe,{content:i.character.description}),(!i.character.descriptionType||i.character.descriptionType!=="markdown")&&e.jsx(l,{variant:"body2",children:i.character.description})]}),e.jsxs(o,{sx:{mt:3},children:[e.jsx(l,{variant:"subtitle2",gutterBottom:!0,children:"Adjust HP"}),e.jsxs(o,{sx:{display:"flex",gap:1},children:[e.jsx(j,{variant:"outlined",size:"small",onClick:()=>k(i.id,i.currentHp-1),children:"-1"}),e.jsx(j,{variant:"outlined",size:"small",onClick:()=>k(i.id,i.currentHp-5),children:"-5"}),e.jsx(j,{variant:"outlined",color:"primary",size:"small",onClick:()=>k(i.id,i.currentHp+1),children:"+1"}),e.jsx(j,{variant:"outlined",color:"primary",size:"small",onClick:()=>k(i.id,i.currentHp+5),children:"+5"})]})]})]})})}),e.jsx(D,{item:!0,xs:12,md:6,children:e.jsx(L,{sx:{backgroundColor:"rgba(40, 40, 40, 0.9)",height:"100%"},children:e.jsxs(N,{children:[e.jsx(l,{variant:"h6",gutterBottom:!0,children:"Combat Notes"}),e.jsx(w,{fullWidth:!0,multiline:!0,rows:8,value:i.notes,onChange:n=>V(i.id,n.target.value),placeholder:"Add notes for this character...",variant:"outlined"})]})})}),i.character.inventory&&i.character.inventory.length>0&&e.jsx(D,{item:!0,xs:12,children:e.jsx(L,{sx:{backgroundColor:"rgba(40, 40, 40, 0.9)"},children:e.jsxs(N,{children:[e.jsx(l,{variant:"h6",gutterBottom:!0,children:"Inventory"}),e.jsx(K,{dense:!0,children:i.character.inventory.map(n=>e.jsxs(Q,{children:[e.jsx(X,{primary:n.name,secondary:n.description}),e.jsxs(l,{variant:"body2",children:["Qty: ",n.quantity]})]},n.id))})]})})})]})]}):e.jsx(o,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"100%"},children:e.jsx(l,{variant:"h6",children:"No participants in combat"})})})]}),e.jsxs(ge,{open:Z,onClose:()=>H(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(je,{children:"Add Combat Participant"}),e.jsx(fe,{children:e.jsxs(o,{sx:{mt:2,display:"flex",flexDirection:"column",gap:2},children:[e.jsxs(ye,{fullWidth:!0,children:[e.jsx(ve,{children:"Character"}),e.jsxs(Ie,{value:T,onChange:n=>W(n.target.value),label:"Character",children:[e.jsx(Y,{value:"",disabled:!0,children:"Select a character"}),y.map(n=>e.jsxs(Y,{value:n.id,children:[n.name," (",n.type,") - HP: ",n.hp]},n.id))]})]}),e.jsx(w,{label:"Initiative",type:"number",value:F,onChange:n=>U(parseInt(n.target.value)||0),fullWidth:!0})]})}),e.jsxs(Ce,{children:[e.jsx(j,{onClick:()=>H(!1),children:"Cancel"}),e.jsx(j,{onClick:te,color:"primary",variant:"contained",disabled:!T,children:"Add"})]})]})]})},Me=()=>{var p;const a=be(),$=ke(),S=M(I=>I.combats),f=(p=$.state)==null?void 0:p.combatId,y=S.find(I=>I.id===f);d.useEffect(()=>{(!f||!y)&&a("/map")},[f,y,a]);const g=()=>{a(-1)};return y?e.jsx(o,{sx:{height:"100%",display:"flex",flexDirection:"column"},children:e.jsx(we,{combat:y,onClose:g})}):e.jsxs(o,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100%",p:3},children:[e.jsx(l,{variant:"h6",children:"Loading combat..."}),e.jsx(j,{onClick:()=>a("/map"),sx:{mt:2},children:"Return to Map"})]})};export{Me as CombatSessionView};
//# sourceMappingURL=CombatSessionView-OvyEre1B.js.map
