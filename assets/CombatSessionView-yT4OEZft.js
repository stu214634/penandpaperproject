import{j as e,B as o,P as D,I as A,a0 as re,d as l,a2 as O,e as g,al as ie,L as V,f as q,g as ae,aa as se,am as oe,h as G,o as P,an as le,a1 as ce,ad as de,ao as ue,N as T,X as $,Y as R,l as xe,m as he,n as pe,ae as me,af as ge,ag as je,ah as K,r as fe}from"./mui-vendor-BNyFSCPN.js";import{r as c,i as ye,u as ve}from"./react-vendor-BzdEknB4.js";import{u as z,M as Ie}from"./index-CP-ZdiZD.js";import"./map-vendor-CMk8R3PE.js";import"./utilities-BTDtKTyc.js";const Ce=({combat:a,onClose:M})=>{const w=z(n=>n.playTrack),j=z(n=>n.stopIndividualTrack),f=z(n=>n.characters),m=c.useRef(null),h=c.useRef(null),v=c.useRef(!1),[d,I]=c.useState([]),[u,C]=c.useState(0),[Q,B]=c.useState(1),[X,H]=c.useState(!1),[S,L]=c.useState(""),[N,E]=c.useState(10),[W,Y]=c.useState(null);c.useEffect(()=>{if(!v.current){if(a.entrySound){const n=`/audio/${a.entrySound}`;m.current=n,w(n,{replace:!1,locationId:`combat-entrysound-${a.id}`,loop:!1})}if(a.backgroundMusic){const n=`/audio/${a.backgroundMusic}`;h.current=n,w(n,{replace:!1,locationId:`combat-bgm-${a.id}`,loop:!0})}v.current=!0}return()=>{m.current&&(j(m.current),m.current=null),h.current&&(j(h.current),h.current=null)}},[a.id,a.entrySound,a.backgroundMusic]),c.useEffect(()=>{J()},[]);const J=()=>{const n=a.playerCharacters.map(i=>({id:`pc-${i.id}-${Math.random().toString(36).substring(2,9)}`,character:i,initiative:Math.floor(Math.random()*20)+1,currentHp:i.hp,maxHp:i.hp,notes:"",isPlayerCharacter:!0})),s=a.enemies.map(i=>({id:`enemy-${i.id}-${Math.random().toString(36).substring(2,9)}`,character:i,initiative:Math.floor(Math.random()*20)+1,currentHp:i.hp,maxHp:i.hp,notes:"",isPlayerCharacter:!1})),t=[...n,...s].sort((i,x)=>x.initiative-i.initiative);I(t),C(0),B(1)},Z=()=>{if(d.length===0)return;const n=(u+1)%d.length;C(n),n===0&&B(s=>s+1)},r=d[u],_=()=>{var p;if(!S)return;const n=f.find(y=>y.id===S);if(!n)return;const s=n.type==="player",t={id:`${s?"pc":"enemy"}-${n.id}-${Math.random().toString(36).substring(2,9)}`,character:n,initiative:N,currentHp:n.hp,maxHp:n.hp,notes:"",isPlayerCharacter:s},i=[...d,t].sort((y,te)=>te.initiative-y.initiative),x=(p=d[u])==null?void 0:p.id,k=x?i.findIndex(y=>y.id===x):0;I(i),C(k>=0?k:0),H(!1),L(""),E(10)},ee=(n,s)=>{var k;const t=d.map(p=>p.id===n?{...p,initiative:s}:p).sort((p,y)=>y.initiative-p.initiative),i=(k=d[u])==null?void 0:k.id,x=i?t.findIndex(p=>p.id===i):0;I(t),C(x>=0?x:0)},b=(n,s)=>{I(d.map(t=>t.id===n?{...t,currentHp:Math.max(0,Math.min(s,t.maxHp))}:t))},F=(n,s)=>{I(d.map(t=>t.id===n?{...t,notes:s}:t))},ne=n=>{const s=d.findIndex(x=>x.id===n);if(s===-1)return;const t=d.filter(x=>x.id!==n);if(t.length===0){U();return}let i=u;s===u?i=u%t.length:s<u&&(i=u-1),I(t),C(i)},U=()=>{m.current&&(j(m.current),m.current=null),h.current&&(j(h.current),h.current=null),M()};return e.jsxs(o,{sx:{height:"100%",width:"100%",display:"flex",flexDirection:"column",overflow:"hidden",position:"relative",backgroundColor:"#222",backgroundImage:a.backgroundImage?`url(/images/${a.backgroundImage})`:"none",backgroundSize:"cover",backgroundPosition:"center"},children:[e.jsx(o,{sx:{position:"absolute",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.5)",zIndex:0}}),e.jsxs(D,{sx:{p:2,mb:2,display:"flex",justifyContent:"space-between",alignItems:"center",backgroundColor:"rgba(30, 30, 30, 0.9)",position:"relative",zIndex:1},children:[e.jsxs(o,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(A,{onClick:U,sx:{mr:1},children:e.jsx(re,{})}),e.jsx(l,{variant:"h5",children:a.name})]}),e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(O,{label:`Round: ${Q}`,color:"primary",variant:"outlined"}),e.jsx(O,{label:`Difficulty: ${a.difficulty||"Medium"}`,color:"secondary",variant:"outlined"}),e.jsx(g,{variant:"contained",color:"primary",startIcon:e.jsx(ie,{}),onClick:()=>H(!0),children:"Add Participant"})]})]}),e.jsxs(o,{sx:{display:"flex",flex:1,overflow:"hidden",position:"relative",zIndex:1,gap:2,p:2},children:[e.jsxs(D,{sx:{width:300,overflow:"auto",backgroundColor:"rgba(30, 30, 30, 0.8)",p:1},children:[e.jsx(l,{variant:"h6",sx:{mb:2,p:1},children:"Initiative Order"}),e.jsx(V,{children:d.map((n,s)=>e.jsxs(q,{sx:{mb:1,backgroundColor:s===u?"rgba(255, 165, 0, 0.3)":"transparent",borderLeft:s===u?"4px solid orange":"4px solid transparent",transition:"all 0.3s ease",borderRadius:"4px"},secondaryAction:e.jsx(A,{edge:"end",size:"small",onClick:()=>ne(n.id),children:e.jsx(de,{fontSize:"small"})}),children:[e.jsx(ae,{children:n.isPlayerCharacter?e.jsx(se,{color:"primary"}):e.jsx(oe,{color:"error"})}),e.jsx(G,{primary:e.jsxs(o,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsx(l,{variant:"body1",children:n.character.name}),e.jsxs(o,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(le,{badgeContent:n.initiative,color:"primary",sx:{mr:1}}),e.jsx(A,{size:"small",onClick:()=>Y(n.id===W?null:n.id),children:e.jsx(ce,{fontSize:"small"})})]})]}),secondary:e.jsxs(o,{children:[e.jsxs(l,{variant:"caption",component:"div",children:["HP: ",n.currentHp,"/",n.maxHp]}),W===n.id&&e.jsxs(o,{sx:{mt:1,display:"flex",flexDirection:"column",gap:1},children:[e.jsx(P,{label:"Initiative",type:"number",size:"small",value:n.initiative,onChange:t=>ee(n.id,parseInt(t.target.value)||0)}),e.jsx(P,{label:"Current HP",type:"number",size:"small",value:n.currentHp,onChange:t=>b(n.id,parseInt(t.target.value)||0)}),e.jsx(P,{label:"Notes",size:"small",multiline:!0,rows:2,value:n.notes,onChange:t=>F(n.id,t.target.value)})]})]})})]},n.id))})]}),e.jsx(D,{sx:{flex:1,p:2,backgroundColor:"rgba(30, 30, 30, 0.8)",display:"flex",flexDirection:"column"},children:r?e.jsxs(e.Fragment,{children:[e.jsxs(o,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsxs(l,{variant:"h5",children:["Current Turn: ",r.character.name]}),e.jsx(g,{variant:"contained",color:"secondary",endIcon:e.jsx(ue,{}),onClick:Z,children:"Next Turn"})]}),e.jsxs(T,{container:!0,spacing:2,children:[e.jsx(T,{item:!0,xs:12,md:6,children:e.jsx($,{sx:{backgroundColor:"rgba(40, 40, 40, 0.9)",height:"100%"},children:e.jsxs(R,{children:[e.jsx(l,{variant:"h6",gutterBottom:!0,children:"Character Details"}),e.jsxs(l,{variant:"body1",children:["Type: ",r.character.type.toUpperCase()]}),e.jsxs(l,{variant:"body1",children:["HP: ",r.currentHp,"/",r.maxHp]}),e.jsxs(o,{sx:{mt:2},children:[r.character.descriptionType==="markdown"&&e.jsx(Ie,{content:r.character.description}),(!r.character.descriptionType||r.character.descriptionType!=="markdown")&&e.jsx(l,{variant:"body2",children:r.character.description})]}),e.jsxs(o,{sx:{mt:3},children:[e.jsx(l,{variant:"subtitle2",gutterBottom:!0,children:"Adjust HP"}),e.jsxs(o,{sx:{display:"flex",gap:1},children:[e.jsx(g,{variant:"outlined",size:"small",onClick:()=>b(r.id,r.currentHp-1),children:"-1"}),e.jsx(g,{variant:"outlined",size:"small",onClick:()=>b(r.id,r.currentHp-5),children:"-5"}),e.jsx(g,{variant:"outlined",color:"primary",size:"small",onClick:()=>b(r.id,r.currentHp+1),children:"+1"}),e.jsx(g,{variant:"outlined",color:"primary",size:"small",onClick:()=>b(r.id,r.currentHp+5),children:"+5"})]})]})]})})}),e.jsx(T,{item:!0,xs:12,md:6,children:e.jsx($,{sx:{backgroundColor:"rgba(40, 40, 40, 0.9)",height:"100%"},children:e.jsxs(R,{children:[e.jsx(l,{variant:"h6",gutterBottom:!0,children:"Combat Notes"}),e.jsx(P,{fullWidth:!0,multiline:!0,rows:8,value:r.notes,onChange:n=>F(r.id,n.target.value),placeholder:"Add notes for this character...",variant:"outlined"})]})})}),r.character.inventory&&r.character.inventory.length>0&&e.jsx(T,{item:!0,xs:12,children:e.jsx($,{sx:{backgroundColor:"rgba(40, 40, 40, 0.9)"},children:e.jsxs(R,{children:[e.jsx(l,{variant:"h6",gutterBottom:!0,children:"Inventory"}),e.jsx(V,{dense:!0,children:r.character.inventory.map(n=>e.jsxs(q,{children:[e.jsx(G,{primary:n.name,secondary:n.description}),e.jsxs(l,{variant:"body2",children:["Qty: ",n.quantity]})]},n.id))})]})})})]})]}):e.jsx(o,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"100%"},children:e.jsx(l,{variant:"h6",children:"No participants in combat"})})})]}),e.jsxs(xe,{open:X,onClose:()=>H(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(he,{children:"Add Combat Participant"}),e.jsx(pe,{children:e.jsxs(o,{sx:{mt:2,display:"flex",flexDirection:"column",gap:2},children:[e.jsxs(me,{fullWidth:!0,children:[e.jsx(ge,{children:"Character"}),e.jsxs(je,{value:S,onChange:n=>L(n.target.value),label:"Character",children:[e.jsx(K,{value:"",disabled:!0,children:"Select a character"}),f.map(n=>e.jsxs(K,{value:n.id,children:[n.name," (",n.type,") - HP: ",n.hp]},n.id))]})]}),e.jsx(P,{label:"Initiative",type:"number",value:N,onChange:n=>E(parseInt(n.target.value)||0),fullWidth:!0})]})}),e.jsxs(fe,{children:[e.jsx(g,{onClick:()=>H(!1),children:"Cancel"}),e.jsx(g,{onClick:_,color:"primary",variant:"contained",disabled:!S,children:"Add"})]})]})]})},Se=()=>{var h;const a=ye(),M=ve(),w=z(v=>v.combats),j=(h=M.state)==null?void 0:h.combatId,f=w.find(v=>v.id===j);c.useEffect(()=>{(!j||!f)&&a("/map")},[j,f,a]);const m=()=>{a(-1)};return f?e.jsx(o,{sx:{height:"100%",display:"flex",flexDirection:"column"},children:e.jsx(Ce,{combat:f,onClose:m})}):e.jsxs(o,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100%",p:3},children:[e.jsx(l,{variant:"h6",children:"Loading combat..."}),e.jsx(g,{onClick:()=>a("/map"),sx:{mt:2},children:"Return to Map"})]})};export{Se as CombatSessionView};
//# sourceMappingURL=CombatSessionView-yT4OEZft.js.map
