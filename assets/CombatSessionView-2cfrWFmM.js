import{j as t,B as o,P as U,I as W,a0 as ue,d as l,a2 as V,e as f,al as xe,L as Z,f as ee,g as he,aa as F,am as te,h as ne,o as P,an as pe,a1 as me,ad as fe,ao as ge,N as B,X as q,Y as G,l as je,m as ye,n as ve,a6 as Ie,ab as Ce,r as be}from"./mui-vendor-BNyFSCPN.js";import{r as d,i as ke,u as Pe}from"./react-vendor-BzdEknB4.js";import{u as D,M as He}from"./index-B0S_hfGj.js";import"./map-vendor-CMk8R3PE.js";import"./utilities-BTDtKTyc.js";const Te=({combat:a,onClose:R})=>{const M=D(e=>e.playTrack),g=D(e=>e.stopIndividualTrack),j=D(e=>e.characters),m=d.useRef(null),p=d.useRef(null),I=d.useRef(!1),[u,C]=d.useState([]),[x,H]=d.useState(0),[re,K]=d.useState(1),[ie,N]=d.useState(!1),[$,Q]=d.useState(""),[b,z]=d.useState(10),[X,se]=d.useState(null),[A,E]=d.useState(null);d.useEffect(()=>{if(!I.current){if(a.entrySound){const e=`/audio/${a.entrySound}`;m.current=e,M(e,{replace:!1,locationId:`combat-entrysound-${a.id}`,loop:!1})}if(a.backgroundMusic){const e=`/audio/${a.backgroundMusic}`;p.current=e,M(e,{replace:!1,locationId:`combat-bgm-${a.id}`,loop:!0})}I.current=!0}return()=>{m.current&&(g(m.current),m.current=null),p.current&&(g(p.current),p.current=null)}},[a.id,a.entrySound,a.backgroundMusic]),d.useEffect(()=>{ae()},[]);const ae=()=>{const e=a.playerCharacters.map(i=>({id:`pc-${i.id}-${Math.random().toString(36).substring(2,9)}`,character:i,initiative:0,currentHp:i.hp,maxHp:i.hp,notes:"",isPlayerCharacter:!0})),n=a.enemies.map(i=>({id:`enemy-${i.id}-${Math.random().toString(36).substring(2,9)}`,character:i,initiative:Math.floor(Math.random()*20)+1,currentHp:i.hp,maxHp:i.hp,notes:"",isPlayerCharacter:!1})),r=[...e,...n].sort((i,c)=>c.initiative-i.initiative);C(r),H(0),K(1)},oe=()=>{if(u.length===0)return;const e=(x+1)%u.length;H(e),E(u[e].id),e===0&&K(n=>n+1)},h=u[x],s=u.find(e=>e.id===(A||(h==null?void 0:h.id)));d.useEffect(()=>{h&&!A&&E(h.id)},[h]);const le=()=>{var y;if(!$)return;const e=j.find(O=>O.id===$);if(!e)return;const n=e.type==="player",r=typeof b=="string"?parseInt(b)||0:b,i={id:`${n?"pc":"enemy"}-${e.id}-${Math.random().toString(36).substring(2,9)}`,character:e,initiative:r,currentHp:e.hp,maxHp:e.hp,notes:"",isPlayerCharacter:n},c=[...u,i],T=Y(c),S=(y=u[x])==null?void 0:y.id,w=S?T.findIndex(O=>O.id===S):0;C(T),H(w>=0?w:0),N(!1),Q(""),z(10)},Y=e=>[...e].sort((n,r)=>{const i=typeof n.initiative=="string"?parseInt(n.initiative)||0:n.initiative;return(typeof r.initiative=="string"?parseInt(r.initiative)||0:r.initiative)-i}),L=(e,n)=>{var w;const r=typeof n=="string"?parseInt(n)||0:n,i=u.map(y=>y.id===e?{...y,initiative:r}:y),c=Y(i),T=(w=u[x])==null?void 0:w.id,S=T?c.findIndex(y=>y.id===T):0;C(c),H(S>=0?S:0)},v=(e,n)=>{const r=typeof n=="string"?parseInt(n)||0:n;C(u.map(i=>i.id===e?{...i,currentHp:Math.max(0,Math.min(r,i.maxHp))}:i))},_=(e,n)=>{C(u.map(r=>r.id===e?{...r,notes:n}:r))},ce=e=>{const n=u.findIndex(c=>c.id===e);if(n===-1)return;const r=u.filter(c=>c.id!==e);if(r.length===0){J();return}let i=x;n===x?i=x%r.length:n<x&&(i=x-1),C(r),H(i)},de=e=>{E(e)},J=()=>{m.current&&(g(m.current),m.current=null),p.current&&(g(p.current),p.current=null),R()},k=e=>typeof e=="string"?parseInt(e)||0:e;return t.jsxs(o,{sx:{height:"100%",width:"100%",display:"flex",flexDirection:"column",overflow:"hidden",position:"relative",backgroundColor:"#222",backgroundImage:a.backgroundImage?`url(/images/${a.backgroundImage})`:"none",backgroundSize:"cover",backgroundPosition:"center"},children:[t.jsx(o,{sx:{position:"absolute",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.5)",zIndex:0}}),t.jsxs(U,{sx:{p:2,mb:2,display:"flex",justifyContent:"space-between",alignItems:"center",backgroundColor:"rgba(30, 30, 30, 0.9)",position:"relative",zIndex:1},children:[t.jsxs(o,{sx:{display:"flex",alignItems:"center"},children:[t.jsx(W,{onClick:J,sx:{mr:1},children:t.jsx(ue,{})}),t.jsx(l,{variant:"h5",children:a.name})]}),t.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:2},children:[t.jsx(V,{label:`Round: ${re}`,color:"primary",variant:"outlined"}),t.jsx(V,{label:`Difficulty: ${a.difficulty||"Medium"}`,color:"secondary",variant:"outlined"}),t.jsx(f,{variant:"contained",color:"primary",startIcon:t.jsx(xe,{}),onClick:()=>N(!0),children:"Add Participant"})]})]}),t.jsxs(o,{sx:{display:"flex",flex:1,overflow:"hidden",position:"relative",zIndex:1,gap:2,p:2},children:[t.jsxs(U,{sx:{width:300,overflow:"auto",backgroundColor:"rgba(30, 30, 30, 0.8)",p:1},children:[t.jsx(l,{variant:"h6",sx:{mb:2,p:1},children:"Initiative Order"}),t.jsx(Z,{children:u.map((e,n)=>t.jsxs(ee,{sx:{mb:1,backgroundColor:n===x?"rgba(255, 165, 0, 0.3)":e.id===A&&n!==x?"rgba(25, 118, 210, 0.2)":"transparent",borderLeft:n===x?"4px solid orange":e.id===A?"4px solid #1976d2":"4px solid transparent",transition:"all 0.3s ease",borderRadius:"4px",cursor:"pointer"},onClick:()=>de(e.id),secondaryAction:t.jsx(W,{edge:"end",size:"small",onClick:r=>{r.stopPropagation(),ce(e.id)},children:t.jsx(fe,{fontSize:"small"})}),children:[t.jsx(he,{children:e.isPlayerCharacter?t.jsx(F,{color:"primary"}):t.jsx(te,{color:"error"})}),t.jsx(ne,{primary:t.jsxs(o,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[t.jsx(l,{variant:"body1",children:e.character.name}),t.jsxs(o,{sx:{display:"flex",alignItems:"center"},children:[t.jsx(pe,{badgeContent:e.initiative,color:"primary",sx:{mr:1}}),t.jsx(W,{size:"small",onClick:r=>{r.stopPropagation(),se(e.id===X?null:e.id)},children:t.jsx(me,{fontSize:"small"})})]})]}),secondary:t.jsxs(o,{children:[t.jsxs(l,{variant:"caption",component:"div",children:["HP: ",k(e.currentHp),"/",e.maxHp]}),X===e.id&&t.jsxs(o,{sx:{mt:1,display:"flex",flexDirection:"column",gap:1},children:[t.jsx(P,{label:"Initiative",size:"small",value:e.initiative,onChange:r=>{const i=r.target.value;if(i==="")L(e.id,"");else{const c=parseInt(i);isNaN(c)||L(e.id,c)}},onBlur:()=>{(typeof e.initiative=="string"||isNaN(e.initiative))&&L(e.id,0)},inputProps:{min:0,step:1},helperText:"Higher initiative goes first"}),t.jsx(P,{label:"Current HP",size:"small",value:e.currentHp,onChange:r=>{const i=r.target.value;if(i==="")v(e.id,"");else{const c=parseInt(i);isNaN(c)||v(e.id,c)}},onBlur:()=>{(typeof e.currentHp=="string"||isNaN(e.currentHp))&&v(e.id,0)},inputProps:{min:0,max:e.maxHp,step:1},helperText:`Max: ${e.maxHp}`}),t.jsx(P,{label:"Notes",size:"small",multiline:!0,rows:2,value:e.notes,onChange:r=>_(e.id,r.target.value)})]})]})})]},e.id))})]}),t.jsx(U,{sx:{flex:1,p:2,backgroundColor:"rgba(30, 30, 30, 0.8)",display:"flex",flexDirection:"column"},children:s?t.jsxs(t.Fragment,{children:[t.jsxs(o,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[t.jsxs(o,{children:[t.jsx(l,{variant:"h5",children:s.id===(h==null?void 0:h.id)?`Current Turn: ${s.character.name}`:s.character.name}),s.id!==(h==null?void 0:h.id)&&t.jsx(l,{variant:"caption",color:"text.secondary",children:"Viewing details - not the active turn"})]}),t.jsx(f,{variant:"contained",color:"secondary",endIcon:t.jsx(ge,{}),onClick:oe,children:"Next Turn"})]}),t.jsxs(B,{container:!0,spacing:2,children:[t.jsx(B,{item:!0,xs:12,md:6,children:t.jsx(q,{sx:{backgroundColor:"rgba(40, 40, 40, 0.9)",height:"100%"},children:t.jsxs(G,{children:[t.jsx(l,{variant:"h6",gutterBottom:!0,children:"Character Details"}),t.jsxs(l,{variant:"body1",children:["Type: ",s.character.type.toUpperCase()]}),t.jsxs(l,{variant:"body1",children:["HP: ",k(s.currentHp),"/",s.maxHp]}),t.jsxs(o,{sx:{mt:2},children:[s.character.descriptionType==="markdown"&&t.jsx(He,{content:s.character.description}),(!s.character.descriptionType||s.character.descriptionType!=="markdown")&&t.jsx(l,{variant:"body2",children:s.character.description})]}),t.jsxs(o,{sx:{mt:3},children:[t.jsx(l,{variant:"subtitle2",gutterBottom:!0,children:"Adjust HP"}),t.jsxs(o,{sx:{display:"flex",gap:1},children:[t.jsx(f,{variant:"outlined",size:"small",onClick:()=>{const e=k(s.currentHp);v(s.id,Math.max(0,e-1))},children:"-1"}),t.jsx(f,{variant:"outlined",size:"small",onClick:()=>{const e=k(s.currentHp);v(s.id,Math.max(0,e-5))},children:"-5"}),t.jsx(f,{variant:"outlined",color:"primary",size:"small",onClick:()=>{const e=k(s.currentHp);v(s.id,Math.min(s.maxHp,e+1))},children:"+1"}),t.jsx(f,{variant:"outlined",color:"primary",size:"small",onClick:()=>{const e=k(s.currentHp);v(s.id,Math.min(s.maxHp,e+5))},children:"+5"})]})]})]})})}),t.jsx(B,{item:!0,xs:12,md:6,children:t.jsx(q,{sx:{backgroundColor:"rgba(40, 40, 40, 0.9)",height:"100%"},children:t.jsxs(G,{children:[t.jsx(l,{variant:"h6",gutterBottom:!0,children:"Combat Notes"}),t.jsx(P,{fullWidth:!0,multiline:!0,rows:8,value:s.notes,onChange:e=>_(s.id,e.target.value),placeholder:"Add notes for this character...",variant:"outlined"})]})})}),s.character.inventory&&s.character.inventory.length>0&&t.jsx(B,{item:!0,xs:12,children:t.jsx(q,{sx:{backgroundColor:"rgba(40, 40, 40, 0.9)"},children:t.jsxs(G,{children:[t.jsx(l,{variant:"h6",gutterBottom:!0,children:"Inventory"}),t.jsx(Z,{dense:!0,children:s.character.inventory.map(e=>t.jsxs(ee,{children:[t.jsx(ne,{primary:e.name,secondary:e.description}),t.jsxs(l,{variant:"body2",children:["Qty: ",e.quantity]})]},e.id))})]})})})]})]}):t.jsx(o,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"100%"},children:t.jsx(l,{variant:"h6",children:"No participants in combat"})})})]}),t.jsxs(je,{open:ie,onClose:()=>N(!1),maxWidth:"sm",fullWidth:!0,children:[t.jsx(ye,{children:"Add Combat Participant"}),t.jsx(ve,{children:t.jsxs(o,{sx:{mt:2,display:"flex",flexDirection:"column",gap:2},children:[t.jsx(Ie,{options:j,value:j.find(e=>e.id===$)||null,onChange:(e,n)=>{Q((n==null?void 0:n.id)||"")},getOptionLabel:e=>`${e.name} (${e.type}) - HP: ${e.hp}`,renderOption:(e,n)=>{const{key:r,...i}=e;return t.jsx("li",{...i,children:t.jsxs(o,{sx:{display:"flex",alignItems:"center"},children:[n.type==="npc"?t.jsx(F,{color:"primary",sx:{mr:1}}):n.type==="merchant"?t.jsx(Ce,{color:"secondary",sx:{mr:1}}):n.type==="enemy"?t.jsx(te,{color:"error",sx:{mr:1}}):t.jsx(F,{color:"success",sx:{mr:1}}),t.jsxs(o,{children:[t.jsx(l,{variant:"body1",children:n.name}),t.jsxs(l,{variant:"caption",color:"text.secondary",children:[n.type.toUpperCase()," â€¢ HP: ",n.hp]})]})]})},r)},renderInput:e=>t.jsx(P,{...e,label:"Character",fullWidth:!0,helperText:"Select a character to add to combat"}),isOptionEqualToValue:(e,n)=>e.id===n.id}),t.jsx(P,{label:"Initiative",value:b,onChange:e=>{const n=e.target.value;if(n==="")z("");else{const r=parseInt(n);isNaN(r)||z(r)}},onBlur:()=>{(b===""||typeof b=="string")&&z(0)},fullWidth:!0,helperText:"Higher initiative goes first"})]})}),t.jsxs(be,{children:[t.jsx(f,{onClick:()=>N(!1),children:"Cancel"}),t.jsx(f,{onClick:le,color:"primary",variant:"contained",disabled:!$,children:"Add"})]})]})]})},ze=()=>{var p;const a=ke(),R=Pe(),M=D(I=>I.combats),g=(p=R.state)==null?void 0:p.combatId,j=M.find(I=>I.id===g);d.useEffect(()=>{(!g||!j)&&a("/map")},[g,j,a]);const m=()=>{a(-1)};return j?t.jsx(o,{sx:{height:"100%",display:"flex",flexDirection:"column"},children:t.jsx(Te,{combat:j,onClose:m})}):t.jsxs(o,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100%",p:3},children:[t.jsx(l,{variant:"h6",children:"Loading combat..."}),t.jsx(f,{onClick:()=>a("/map"),sx:{mt:2},children:"Return to Map"})]})};export{ze as CombatSessionView};
//# sourceMappingURL=CombatSessionView-2cfrWFmM.js.map
